<!DOCTYPE html>
<html lang="en"><meta charset="utf-8"><meta name="generator" content="Hugo 0.68.3" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><title>Lua 학습 6일차&nbsp;&ndash;&nbsp;/dev/log</title><link rel="stylesheet" href="/css/core.min.e423c83b21da92bb4e8bb830c9f1f244c55526656580aee89a97a9a3286de39f5329f5710761b5118b808bb4ad342ff6.css" integrity="sha384-5CPIOyHakrtOi7gwyfHyRMVVJmVlgK7ompepoyht459TKfVxB2G1EYuAi7StNC/2"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Lua 학습 6일차" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/"><span class="site name">/dev/log</span></a></span>
        <span class="header right-side"><div class="nav wrap"><nav class="nav"><a class="nav item" href="/categories/">Categories</a><a class="nav item" href="/tags/">Tags</a></nav></div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">Lua 학습 6일차</h1><p class="article date">2020-05-19</p></section><article class="article markdown-body"><h2 id="embedding-lua">Embedding Lua</h2>
<p>오늘은 Lua를 C언어로 작성된 프로그램에서 사용하는 방법을 공부했다. 그 중 설정 파일은 Lua로 작성하는 것을 실습해보았다. 지금부터는 강의 자료보다 매뉴얼이 더 도움이 되기 때문에 매뉴얼을 중심으로 살펴볼 것이다. Lua의 매뉴얼은 굉장히 심플하게 되었있지만 부족함이 없다.</p>
<h3 id="실습-설정">실습 설정</h3>
<p>'별 찍기'라는 예제를 만들 것이다. <a href="https://boj.kr/2438"target="_blank">BOJ 2438번 별 찍기 - 1</a>과 동일한 모양을 만들 것이다. 이때, 필요한 변수 <code>N</code>을 C에서 받는 것이 아니라 'config.lua' 파일을 Lua가 읽어 C로 전달하도록 만들 것이다.</p>
<p><code>N</code>은 [0, 1000] 범위에 포함되는 정수이다.</p>
<h3 id="기준-코드">기준 코드</h3>
<p>비교를 위한 코드이다. 변수 <code>N</code>이 설정 값을 정의되어 있어 바꾸고 싶을 경우 매번 다시 컴파일 해야한다.</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*
</span><span class="cm"> * starry.h
</span><span class="cm"> */</span>

<span class="cp">#pragma once
</span><span class="cp"></span>
<span class="cp">#define N_MAX 1000
</span><span class="cp">#define N_MIN 0
</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*
</span><span class="cm"> * config.h
</span><span class="cm"> */</span>

<span class="cp">#pragma once
</span><span class="cp"></span>
<span class="cp">#define N 42
</span></code></pre></div><div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*
</span><span class="cm"> * main.c
</span><span class="cm"> */</span>

<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;config.h&#34;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&#34;starry.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">N</span> <span class="o">&lt;</span> <span class="n">N_MIN</span> <span class="o">||</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="n">N_MAX</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;starry: N must be an integer between %d and %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">N_MIN</span><span class="p">,</span>
            <span class="n">N_MAX</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&#34;*&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><h3 id="lua-임베딩하기">Lua 임베딩하기</h3>
<p><code>config.h</code>파일 대신 <code>config.lua</code>를 사용할 것이다.</p>
<div class="highlight"><pre class="chroma"><code class="language-lua" data-lang="lua"><span class="c1">-- config.lua</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">42</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*
</span><span class="cm"> * main.c
</span><span class="cm"> */</span>

<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;starry.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">N</span><span class="p">;</span>

  <span class="n">N</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">N</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&#34;*&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p><code>load_config</code>라는 새로운 서브루틴을 작성하여 Lua 스크립트를 실행하여 설정값은 가져오도록 하자.</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*
</span><span class="cm"> * load_config.c
</span><span class="cm"> */</span>

<span class="cp">#include</span> <span class="cpf">&lt;stddef.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;lauxlib.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;lua.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;lualib.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;starry.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="kt">int</span> <span class="nf">load_config</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
  <span class="n">lua_Integer</span> <span class="n">N</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">((</span><span class="n">L</span> <span class="o">=</span> <span class="n">luaL_newstate</span><span class="p">())</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;starry: failed to create lua instance</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">luaL_openlibs</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">luaL_loadfile</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;config.lua&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LUA_OK</span> <span class="o">||</span>
      <span class="n">lua_pcall</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LUA_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;starry: failed to load config.lua file: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
            <span class="n">lua_tostring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span>
    <span class="n">lua_close</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">type</span> <span class="o">=</span> <span class="n">lua_getglobal</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&#34;N&#34;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">LUA_TNUMBER</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">LUA_TNIL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;starry: the value of N must be set</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;starry: N must be an integer</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">lua_close</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">N</span> <span class="o">=</span> <span class="n">lua_tointeger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">lua_close</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">N</span> <span class="o">&lt;</span> <span class="n">N_MIN</span> <span class="o">||</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="n">N_MAX</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;starry: N must be an integer between %d and %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">N_MIN</span><span class="p">,</span>
            <span class="n">N_MAX</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">N</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h3 id="lua로-확장하기">Lua로 확장하기</h3>
<p><code>N</code>을 입력받기 위해 Lua를 거치기 때문에 중간에서 Lua 코드로 프로그램의 동작을 확장할 수 있다.</p>
<p><code>N</code>을 설정 파일에서 설정해 줄 수 있지만 표준 입력으로 설정할 수도 있게 되었다.</p>
<h4 id="lua를-이용하여-표준-입력으로-받도록-변경하기">Lua를 이용하여 표준 입력으로 받도록 변경하기</h4>
<div class="highlight"><pre class="chroma"><code class="language-lua" data-lang="lua"><span class="c1">-- config.lua</span>
<span class="n">N</span> <span class="o">=</span> <span class="n">io.read</span><span class="p">(</span><span class="s2">&#34;*number&#34;</span><span class="p">)</span>
</code></pre></div><p>이제 표준 입력으로 <code>N</code>의 값을 설정할 수 있다.</p>
<h2 id="참고">참고</h2>
<p><a href="https://dcc.ufrj.br/~fabiom/lua/13Embedding.pdf">https://dcc.ufrj.br/~fabiom/lua/13Embedding.pdf</a><br>
<a href="http://www.lua.org/manual/5.3/">http://www.lua.org/manual/5.3/</a><br>
<a href="https://en.cppreference.com/w/">https://en.cppreference.com/w/</a></p>
<h2 id="소스-코드">소스 코드</h2>
<p><a href="https://github.com/Tetramad/lua-learning-day-6-source">https://github.com/Tetramad/lua-learning-day-6-source</a></p>
</article><section class="article labels"><a class="category" href=/categories/til/>TIL</a><a class="tag" href=/tags/lua/>Lua</a><a class="tag" href=/tags/learn/>Learn</a></section></div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/til/lua-%ED%95%99%EC%8A%B5-5%EC%9D%BC%EC%B0%A8/"><span class="li iconfont icon-article"></span>Lua 학습 5일차</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">/dev/log</p>
    <p class="powerby"><span>Powered by </span><a href="https://gohugo.io" 
        target="_blank">Hugo</a><span> and the </span><a href="https://themes.gohugo.io/hugo-notepadium/" 
        target="_blank">Notepadium</a></p>
</div></section><script defer type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha384-e/4/LvThKH1gwzXhdbY2AsjR3rm7LHWyhIG5C0jiRfn8AN2eTN5ILeztWw0H9jmN" crossorigin="anonymous"></script>
        <script
            type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });</script><script src="/js/hljs.min.0799348a91dce12c6be4a73f943cfe78f181f4e6f6ec35c4af0fca1de377879f77cfab03c30f03a174d675737b5a9314.js" integrity="sha384-B5k0ipHc4Sxr5Kc/lDz&#43;ePGB9Ob27DXErw/KHeN3h593z6sDww8DoXTWdXN7WpMU"></script><script>hljs.initHighlightingOnLoad();</script></body>

</html>